<html>

<head>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://lpcdn.lpsnmedia.net/webagent/client-SDK.min.js"></script>
    
</head>

<body>
    
    <script>
        
       
        
       
        
        
        var greenlight = 0;
        var sendSMS = 0;
        var TimeAgent = 0;
        var TimeCustomer = 0;
        var SDK = lpTag.agentSDK;
        SDK.init();
      
        var updateCallback = function(data) {
           
           
            if (data.newValue.lines[0].source == 'agent') {
                greenlight = 1;
                TimeAgent = data.newValue.lines[0].time;
                console.log(TimeAgent);
               
            }
                    
        };
        
        var updateCallback1 = function(data) {
           
           var length = data.lines.length;
           if(data.lines[(length-2)].source == 'visitor'){
               
               TimeCustomer = data.lines[(length-2)].time;
               var Difference = TimeAgent - TimeCustomer;
               if (Difference > 10000){
                   
                   console.log("sms to send");
                   sendSMS = 1;
                   
               }
               
           }
        };
        
        
        var updateCallback2 = function(data) {
           
           if (sendSMS){
                var str = data.personalInfo.contactInfo[0].email;
                var n = str.indexOf("@liveperson.com");
                var phone = str.substring(0, n);
                console.log(phone);
                sendSMS = 0;
           }
        };
                
      
  
           
        
        
        var notifyWhenDone = function(err) {
            if (err) {
                // Do something with the error
            }
            // called when the bind is completed successfully,
            // or when the action terminated with an error
        };
        
        var notifyWhenDone1 = function(err) {
            if (err) {
                // Do something with the error
            }
            // called when the bind is completed successfully,
            // or when the action terminated with an error
        };
        
        var notifyWhenDone2 = function(err) {
            if (err) {
                // Do something with the error
            }
            // called when the bind is completed successfully,
            // or when the action terminated with an error
        };
     
        var pathToData = "chatTranscript";
       
        SDK.bind(pathToData, updateCallback, notifyWhenDone);
        setInterval(function(){
        if(greenlight){
            greenlight = 0;
             SDK.unbind(pathToData, updateCallback, notifyWhenDone);
             SDK.get(pathToData, updateCallback1, notifyWhenDone1);
             SDK.get("authenticatedData", updateCallback2, notifyWhenDone2);
             SDK.bind(pathToData, updateCallback, notifyWhenDone);
        }
        
            }, 1000);
      
       
    </script>
</body>

</html>
